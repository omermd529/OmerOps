apiVersion: 1

groups:
  - name: EC2-Alerts
    folder: Infrastructure
    interval: 1m
    rules:

      - uid: ec2-node-down
        title: EC2 Node Down
        condition: C
        data:
          - refId: A
            datasourceUid: prometheus
            model:
              expr: up{job="node-exporter"} == 0
              instant: true
          - refId: B
            datasourceUid: __expr__
            model:
              type: reduce
              reducer: last
              expression: A
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
        for: 2m
        labels:
          severity: critical

      - uid: ec2-memory-high
        title: EC2 High Memory Usage
        condition: C
        data:
          - refId: A
            datasourceUid: prometheus
            model:
              expr: |
                100 * (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes))
              instant: true
          - refId: B
            datasourceUid: __expr__
            model:
              type: reduce
              reducer: last
              expression: A
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params: [85]
        for: 5m
        labels:
          severity: warning

      - uid: ec2-disk-high
        title: EC2 Disk Usage High
        condition: C
        data:
          - refId: A
            datasourceUid: prometheus
            model:
              expr: |
                100 * (1 - (
                  node_filesystem_avail_bytes{mountpoint="/"} /
                  node_filesystem_size_bytes{mountpoint="/"}
                ))
              instant: true
          - refId: B
            datasourceUid: __expr__
            model:
              type: reduce
              reducer: last
              expression: A
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params: [85]
        for: 5m
        labels:
          severity: critical
