apiVersion: 1

groups:
  - name: fastapi-alerts
    folder: FastAPI
    interval: 1m
    rules:

      - uid: fastapi-down
        title: FastAPI Service Down
        condition: C
        for: 5m
        data:
          - refId: A
            datasourceUid: prometheus
            model:
              expr: up{job="fastapi"}

          - refId: B
            model:
              type: reduce
              reducer: last

          - refId: C
            model:
              type: threshold
              conditions:
                - evaluator:
                    type: lt
                    params: [1]

        labels:
          severity: critical
        annotations:
          summary: FastAPI is down
          description: FastAPI has been unreachable for more than 5 minutes.

      - uid: fastapi-5xx
        title: High 5xx Error Rate
        condition: C
        for: 3m
        data:
          - refId: A
            datasourceUid: prometheus
            model:
              expr: |
                (sum(rate(http_requests_total{status=~"5.."}[5m])) /
                 sum(rate(http_requests_total[5m]))) * 100

          - refId: B
            model:
              type: reduce
              reducer: last

          - refId: C
            model:
              type: threshold
              conditions:
                - evaluator:
                    type: gt
                    params: [2]

        labels:
          severity: warning
