apiVersion: 1

groups:
  - name: fastapi-alerts
    folder: FastAPI
    interval: 1m
    rules:

      # ==================================================
      # Alert 1: FastAPI Service Down
      # ==================================================
      - uid: fastapi-down
        title: FastAPI Service Down
        condition: A
        for: 5m

        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expr: up{job="fastapi"} == 0
              refId: A

        labels:
          severity: critical
          service: fastapi

        annotations:
          summary: FastAPI service is down
          description: FastAPI has been unreachable for more than 5 minutes.

      # ==================================================
      # Alert 2: High 5xx Error Rate (> 2%)
      # ==================================================
      - uid: fastapi-5xx
        title: High 5xx Error Rate
        condition: A
        for: 3m

        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expr: |
                (
                  sum(rate(http_requests_total{status=~"5.."}[5m]))
                /
                  sum(rate(http_requests_total[5m]))
                ) * 100
              refId: A

        labels:
          severity: warning
          service: fastapi

        annotations:
          summary: High 5xx error rate
          description: 5xx error rate has exceeded 2% for more than 3 minutes.

      # ==================================================
      # Alert 3: High Latency (P95 > 1s)
      # ==================================================
      - uid: fastapi-latency-p95
        title: High Latency (P95)
        condition: A
        for: 5m

        data:
          - refId: A
            datasourceUid: prometheus
            relativeTimeRange:
              from: 300
              to: 0
            model:
              expr: |
                histogram_quantile(
                  0.95,
                  sum(rate(http_request_duration_seconds_bucket[5m])) by (le)
                )
              refId: A

        labels:
          severity: warning
          service: fastapi

        annotations:
          summary: High request latency
          description: P95 latency has been above 1 second for more than 5 minutes.
